#
# This file is responsible for the site which serves the main releases from codeorigin. By default,
# it generates a site that operates in "break glass" emergency mode. All requests are served,
# regardless of where they come from.
#
# In production, the CDN should add a private header to origin fetches. All requests which do not
# include the correct header should be bounced via 301 redirect back to the CDN. This ensures that
# even if a client attempts to link to codeorigin, it will still be served from the CDN. The end
# result should be that codeorigin is only reachable for origin pulls from the CDN, decreasing its
# load and reducing the attack surface for DDOSs.
#
# Configuration information is in the README.md file.
#

# Increase map_hash_bucket_size to accommodate longer CDN tokens
map_hash_bucket_size 128;

# Do not change the following lines. The Dockerfile will set the access key and remove the comment
# at build time if the correct environment variable is set.
##ACTIVATE-XCDNACCESS##map $http_x_cdn_access $reroute_to_cdn { default '1'; CDN_ACCESS_KEY_PLACEHOLDER '0'; }

server {
  listen        80;
  listen        [::]:80;
  server_name   localhost;

  access_log  /var/log/nginx/host.access.log  main;

  location / {
    root        /usr/share/nginx/html;
    index       index.html index.htm;

    # Do not change the following line. The Dockerfile will set the access key and remove the
    # comment at build time if the correct environment variable is set.
    ##ACTIVATE-XCDNACCESS##if ($reroute_to_cdn) { return 301 $scheme://code2.jquery.com$uri; }

  }

  # PHP configuration for purge.php

  location ~ \.php$ {
    root           /usr/share/nginx/html;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include        fastcgi_params;
  }

  # Redirect requests to the root to the release viewer

  location ~ ^/(?:/)?$ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com;
  }

  # Redirect requests to paths known to be non-release files (e.g., git versions and their assets)
  # to the viewer. Jenkins needs access to the host that delivers these files, and codeorigin is
  # intended to be more tightly managed via github repo.

  # Redirect to releases.jquery.com/

  location ~ ^/git(?:/(.*))? {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com$request_uri;
  }

  # Redirect specific project pages to releases.jquery.com
  location ~ ^/jquery(?:/)?$ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com/jquery/;
  }

  location ~ ^/ui(?:/)?$ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com/ui/;
  }

  location ~ ^/mobile(?:/)?$ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com/mobile/;
  }

  location ~ ^/color(?:/)?$ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com/color/;
  }

  location ~ ^/qunit(?:/)?$ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com/qunit/;
  }

  location ~ ^/pep(?:/)?$ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com/pep/;
  }

  # Redirect to releases.jquery.com/git/

  location ~* -git\.(js|min.js|slim.js|slim.min.js|css)$ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com/git$request_uri;
  }

  location ^~ /mobile/git/ {
    expires off;
    gzip on;
    return 301 https://releases.jquery.com/git$request_uri;
  }

  # Redirect some known legacy URLs that may still point to code.jquery.com. This list is a
  # workaround, and should not need to be expanded.

  rewrite ^/ui/images/ui-icons_cc0000_256x240\.png$ https://releases.jquery.com/git/ui/images/ui-icons_cc0000_256x240.png permanent;
  rewrite ^/ui/images/ui-icons_777777_256x240\.png$ https://releases.jquery.com/git/ui/images/ui-icons_777777_256x240.png permanent;
  rewrite ^/ui/images/ui-icons_777620_256x240\.png$ https://releases.jquery.com/git/ui/images/ui-icons_777620_256x240.png permanent;
  rewrite ^/ui/images/ui-icons_555555_256x240\.png$ https://releases.jquery.com/git/ui/images/ui-icons_555555_256x240.png permanent;
  rewrite ^/ui/images/ui-icons_444444_256x240\.png$ https://releases.jquery.com/git/ui/images/ui-icons_444444_256x240.png permanent;
  rewrite ^/ui/images/ui-bg_flat_0_aaaaaa_40x100\.png$ https://releases.jquery.com/git/ui/images/ui-bg_flat_0_aaaaaa_40x100.png permanent;
  rewrite ^/ui/images/ui-icons_ffffff_256x240\.png$ https://releases.jquery.com/git/ui/images/ui-icons_ffffff_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-icons_cc0000_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_cc0000_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-bg_highlight-soft_75_cccccc_1x100\.png$ https://releases.jquery.com/git/ui/_images/images/ui-bg_highlight-soft_75_cccccc_1x100.png permanent;
  rewrite ^/ui/_images/images/ui-icons_2e83ff_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_2e83ff_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-bg_flat_75_ffffff_40x100\.png$ https://releases.jquery.com/git/ui/_images/images/ui-bg_flat_75_ffffff_40x100.png permanent;
  rewrite ^/ui/_images/images/ui-bg_glass_95_fef1ec_1x400\.png$ https://releases.jquery.com/git/ui/_images/images/ui-bg_glass_95_fef1ec_1x400.png permanent;
  rewrite ^/ui/_images/images/ui-icons_777777_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_777777_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-bg_glass_65_ffffff_1x400\.png$ https://releases.jquery.com/git/ui/_images/images/ui-bg_glass_65_ffffff_1x400.png permanent;
  rewrite ^/ui/_images/images/ui-icons_777620_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_777620_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-icons_555555_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_555555_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-bg_glass_75_e6e6e6_1x400\.png$ https://releases.jquery.com/git/ui/_images/images/ui-bg_glass_75_e6e6e6_1x400.png permanent;
  rewrite ^/ui/_images/images/ui-icons_222222_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_222222_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-icons_888888_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_888888_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-icons_444444_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_444444_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-icons_cd0a0a_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_cd0a0a_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-bg_glass_55_fbf9ee_1x400\.png$ https://releases.jquery.com/git/ui/_images/images/ui-bg_glass_55_fbf9ee_1x400.png permanent;
  rewrite ^/ui/_images/images/ui-icons_454545_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_454545_256x240.png permanent;
  rewrite ^/ui/_images/images/ui-bg_glass_75_dadada_1x400\.png$ https://releases.jquery.com/git/ui/_images/images/ui-bg_glass_75_dadada_1x400.png permanent;
  rewrite ^/ui/_images/images/ui-bg_flat_0_aaaaaa_40x100\.png$ https://releases.jquery.com/git/ui/_images/images/ui-bg_flat_0_aaaaaa_40x100.png permanent;
  rewrite ^/ui/_images/images/ui-icons_ffffff_256x240\.png$ https://releases.jquery.com/git/ui/_images/images/ui-icons_ffffff_256x240.png permanent;
  rewrite ^/ui/_images/ui-bg_highlight-soft_75_cccccc_1x100\.png$ https://releases.jquery.com/git/ui/_images/ui-bg_highlight-soft_75_cccccc_1x100.png permanent;
  rewrite ^/ui/_images/ui-icons_2e83ff_256x240\.png$ https://releases.jquery.com/git/ui/_images/ui-icons_2e83ff_256x240.png permanent;
  rewrite ^/ui/_images/ui-bg_flat_75_ffffff_40x100\.png$ https://releases.jquery.com/git/ui/_images/ui-bg_flat_75_ffffff_40x100.png permanent;
  rewrite ^/ui/_images/ui-bg_glass_95_fef1ec_1x400\.png$ https://releases.jquery.com/git/ui/_images/ui-bg_glass_95_fef1ec_1x400.png permanent;
  rewrite ^/ui/_images/ui-bg_glass_65_ffffff_1x400\.png$ https://releases.jquery.com/git/ui/_images/ui-bg_glass_65_ffffff_1x400.png permanent;
  rewrite ^/ui/_images/ui-bg_glass_75_e6e6e6_1x400\.png$ https://releases.jquery.com/git/ui/_images/ui-bg_glass_75_e6e6e6_1x400.png permanent;
  rewrite ^/ui/_images/ui-icons_222222_256x240\.png$ https://releases.jquery.com/git/ui/_images/ui-icons_222222_256x240.png permanent;
  rewrite ^/ui/_images/ui-icons_888888_256x240\.png$ https://releases.jquery.com/git/ui/_images/ui-icons_888888_256x240.png permanent;
  rewrite ^/ui/_images/ui-icons_cd0a0a_256x240\.png$ https://releases.jquery.com/git/ui/_images/ui-icons_cd0a0a_256x240.png permanent;
  rewrite ^/ui/_images/ui-bg_glass_55_fbf9ee_1x400\.png$ https://releases.jquery.com/git/ui/_images/ui-bg_glass_55_fbf9ee_1x400.png permanent;
  rewrite ^/ui/_images/ui-icons_454545_256x240\.png$ https://releases.jquery.com/git/ui/_images/ui-icons_454545_256x240.png permanent;
  rewrite ^/ui/_images/ui-bg_glass_75_dadada_1x400\.png$ https://releases.jquery.com/git/ui/_images/ui-bg_glass_75_dadada_1x400.png permanent;
  rewrite ^/ui/_images/ui-bg_flat_0_aaaaaa_40x100\.png$ https://releases.jquery.com/git/ui/_images/ui-bg_flat_0_aaaaaa_40x100.png permanent;

  #error_page    404              /404.html;

  # redirect server error pages to the static page /50x.html
  #
  error_page    500 502 503 504  /50x.html;
  location = /50x.html {
    root   /usr/share/nginx/html;
  }
}

# vim: ts=2 sw=2 et
